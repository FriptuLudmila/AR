<!-- import aframe and then ar.js with image tracking / location based features -->
<script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

<script>
  // ======= INTERACTIVE AR SYSTEM WITH MULTIPLE SCENARIOS =======

  // State Management
  let firstMarkerScanned = false;
  let secondMarkerUnlocked = false;
  let clickCount = 0;
  let griffinAnimating = false;
  let sceneModelColor = 'original';
  let totalInteractions = 0;

  // Register custom A-Frame components for touch interactions
  AFRAME.registerComponent('tap-listener', {
    init: function() {
      let touchStartTime = 0;

      this.el.addEventListener('touchstart', (e) => {
        touchStartTime = Date.now();
      });

      this.el.addEventListener('touchend', (e) => {
        const touchDuration = Date.now() - touchStartTime;
        if (touchDuration < 200) { // Quick tap
          this.el.emit('tap');
          console.log('Tap detected on', this.el.id);
        }
      });
    }
  });

  window.addEventListener('load', function() {
    const sceneEl = document.querySelector('a-scene');
    const firstNft = document.querySelector('#first-marker');
    const secondNft = document.querySelector('#second-marker');
    const statusText = document.querySelector('#status-text');
    const interactionText = document.querySelector('#interaction-text');

    // Initially hide the second marker
    secondNft.setAttribute('visible', 'false');

    // ======= SCENARIO 1: Sequential Marker Scanning =======
    firstNft.addEventListener('markerFound', function() {
      console.log('First marker (milky) found!');

      if (!firstMarkerScanned) {
        firstMarkerScanned = true;
        secondMarkerUnlocked = true;
        totalInteractions++;

        statusText.setAttribute('text', 'value', 'Scenario 1 Complete! Find booksign.');
        setTimeout(() => {
          interactionText.setAttribute('text', 'value', 'Tap the 3D model to interact!');
        }, 2000);

        // Enable the second marker
        secondNft.setAttribute('visible', 'true');
      }
    });

    // ======= SCENARIO 2: Touch Interaction on First Model =======
    const firstModel = document.querySelector('#first-model');

    const handleFirstModelInteraction = function() {
      clickCount++;
      totalInteractions++;
      console.log('First model interaction! Count:', clickCount);

      if (clickCount === 1) {
        // First tap: Change color
        interactionText.setAttribute('text', 'value', 'Color changed! Tap again!');
        firstModel.setAttribute('material', 'color', '#FF6B6B');
        sceneModelColor = 'red';
      } else if (clickCount === 2) {
        // Second tap: Rotate animation
        interactionText.setAttribute('text', 'value', 'Rotating! Tap again!');
        firstModel.setAttribute('animation', {
          property: 'rotation',
          to: '0 360 0',
          dur: 2000,
          easing: 'linear',
          loop: false
        });
        firstModel.setAttribute('material', 'color', '#4ECDC4');
        sceneModelColor = 'cyan';
      } else if (clickCount === 3) {
        // Third tap: Scale animation
        interactionText.setAttribute('text', 'value', 'Growing! Tap to reset!');
        firstModel.setAttribute('animation', {
          property: 'scale',
          from: '100 100 100',
          to: '150 150 150',
          dur: 1000,
          easing: 'easeInOutQuad',
          loop: false
        });
        firstModel.setAttribute('material', 'color', '#FFE66D');
        sceneModelColor = 'yellow';
      } else {
        // Fourth tap: Reset
        interactionText.setAttribute('text', 'value', 'Reset! Start tapping again!');
        firstModel.setAttribute('animation', {
          property: 'scale',
          to: '100 100 100',
          dur: 1000,
          easing: 'easeInOutQuad',
          loop: false
        });
        firstModel.removeAttribute('material');
        clickCount = 0;
        sceneModelColor = 'original';
      }
    };

    // Listen for tap event
    firstModel.addEventListener('tap', handleFirstModelInteraction);

    // ======= SCENARIO 3: Griffin Model Interactions =======
    secondNft.addEventListener('markerFound', function() {
      console.log('Second marker (booksign) found!');

      if (secondMarkerUnlocked) {
        statusText.setAttribute('text', 'value', 'Scenario 2 Complete! Tap griffin!');
        interactionText.setAttribute('text', 'value', 'Click the Griffin for animation!');
        totalInteractions++;
      } else {
        interactionText.setAttribute('text', 'value', 'Scan first marker first!');
      }
    });

    const griffinModel = document.querySelector('#griffin-model');
    const debugBox = document.querySelector('#debug-box');

    // Touch interaction on Griffin
    const handleGriffinInteraction = function() {
      if (!griffinAnimating) {
        griffinAnimating = true;
        totalInteractions++;
        console.log('Griffin tapped! Total interactions:', totalInteractions);
        interactionText.setAttribute('text', 'value', 'Griffin is flying!');

        // Flying animation
        griffinModel.setAttribute('animation__fly', {
          property: 'position',
          from: '0 0 0',
          to: '0 100 0',
          dur: 2000,
          dir: 'alternate',
          loop: 2,
          easing: 'easeInOutSine'
        });

        // Rotation animation
        griffinModel.setAttribute('animation__spin', {
          property: 'rotation',
          to: '0 360 0',
          dur: 2000,
          loop: 2,
          easing: 'linear'
        });

        setTimeout(() => {
          griffinAnimating = false;
          interactionText.setAttribute('text', 'value', 'Tap again for more!');
        }, 4000);
      }
    };

    griffinModel.addEventListener('tap', handleGriffinInteraction);

    // Touch interaction on debug box
    const handleBoxInteraction = function() {
      totalInteractions++;
      console.log('Box tapped! Total:', totalInteractions);
      const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#95E1D3', '#F38181'];
      const randomColor = colors[Math.floor(Math.random() * colors.length)];
      debugBox.setAttribute('color', randomColor);
      interactionText.setAttribute('text', 'value', 'Box color changed! Total: ' + totalInteractions);
    };

    debugBox.addEventListener('tap', handleBoxInteraction);

    // ======= SCENARIO 4: Proximity Detection =======
    let proximityTimer = 0;
    firstNft.addEventListener('markerFound', function() {
      proximityTimer = setInterval(() => {
        if (firstMarkerScanned) {
          interactionText.setAttribute('text', 'value', 'You are near marker 1!');
        }
      }, 3000);
    });

    firstNft.addEventListener('markerLost', function() {
      clearInterval(proximityTimer);
      interactionText.setAttribute('text', 'value', 'Marker 1 lost!');
    });

    // ======= SCENARIO 5: Multi-Touch Gesture (Double Tap) =======
    let lastTapTime = 0;

    window.addEventListener('touchstart', function(e) {
      const currentTime = Date.now();
      const timeDiff = currentTime - lastTapTime;

      console.log('Touch detected! Time since last tap:', timeDiff + 'ms');

      // Double tap detected if less than 400ms between taps
      if (timeDiff < 400 && timeDiff > 0) {
        totalInteractions++;
        console.log('=== DOUBLE TAP DETECTED! Total interactions:', totalInteractions);

        // Prevent default behavior
        e.preventDefault();

        // Update both text displays
        statusText.setAttribute('text', 'value', 'DOUBLE TAP! Count: ' + totalInteractions);
        interactionText.setAttribute('text', 'value', '*** DOUBLE TAP! ***');
        interactionText.setAttribute('text', 'color', '#FF00FF');

        // Reset after showing message
        setTimeout(() => {
          interactionText.setAttribute('text', 'value', 'Double tap anywhere!');
          interactionText.setAttribute('text', 'color', '#00FF00');
        }, 800);

        // Reset timer to prevent triple-tap
        lastTapTime = 0;
      } else {
        // First tap or timeout expired
        lastTapTime = currentTime;
      }
    }, false);

    // Initial status message
    statusText.setAttribute('text', 'value', 'Scan the first marker (milky)');
    interactionText.setAttribute('text', 'value', 'Interactive AR Experience Ready!');

    // ======= SCENARIO 6: Continuous Stats Display =======
    setInterval(() => {
      if (firstMarkerScanned || secondMarkerUnlocked) {
        console.log('Total Interactions:', totalInteractions);
        console.log('First Marker:', firstMarkerScanned);
        console.log('Second Marker Unlocked:', secondMarkerUnlocked);
      }
    }, 5000);
  });
</script>

<!-- style for the loader -->
<style>
  .arjs-loader {
    height: 100%;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .arjs-loader div {
    text-align: center;
    font-size: 1.25em;
    color: white;
  }
</style>

<body style="margin : 0px; overflow: hidden;">
  <!-- minimal loader shown until image descriptors are loaded. Loading may take a while according to the device computational power -->
  <div class="arjs-loader">
    <div>Loading, please wait...</div>
  </div>

  <!-- a-frame scene -->
  <a-scene
    vr-mode-ui="enabled: false;"
    renderer="logarithmicDepthBuffer: true;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; sourceWidth: 640; sourceHeight: 480; displayWidth: 640; displayHeight: 480;"
  >
    <!-- FIRST NFT MARKER: milky -->
    <a-nft
      id="first-marker"
      type="nft"
      url="./milky"
      smooth="true"
      smoothCount="20"
      smoothTolerance="0.5"
      smoothThreshold="2"
    >
      <!-- First object 3D model with tap interaction -->
      <a-entity
        id="first-model"
        gltf-model="scene.gltf"
        scale="100 100 100"
        position="0 0 0"
        rotation="0 0 0"
        tap-listener
        class="interactive"
      >
      </a-entity>
    </a-nft>

    <!-- SECOND NFT MARKER: booksign (initially hidden) -->
    <a-nft
      id="second-marker"
      type="nft"
      url="./booksign"
      smooth="true"
      smoothCount="20"
      smoothTolerance="0.5"
      smoothThreshold="2"
      visible="false"
    >
      <!-- Second object 3D model - Griffin with tap interaction -->
      <a-entity
        id="griffin-model"
        gltf-model="griffin.gltf"
        scale="50 50 50"
        position="0 0 0"
        rotation="0 0 0"
        tap-listener
        class="interactive"
      >
      </a-entity>
      <!-- Debug red box to verify marker tracking and color interaction -->
      <a-box
        id="debug-box"
        color="red"
        width="50"
        height="50"
        depth="50"
        position="0 25 0"
        opacity="0.5"
        tap-listener
        class="interactive"
      ></a-box>
    </a-nft>

    <!-- Status text displayed on screen -->
    <a-text
      id="status-text"
      value="Initializing..."
      color="yellow"
      position="0 2.5 -3"
      align="center"
      width="6"
    ></a-text>

    <!-- Interaction feedback text -->
    <a-text
      id="interaction-text"
      value="Ready for interactions!"
      color="#00FF00"
      position="0 1.5 -3"
      align="center"
      width="5"
    ></a-text>
    <!-- static camera that moves according to the device movemenents -->
    <a-entity camera></a-entity>
  </a-scene>
</body>